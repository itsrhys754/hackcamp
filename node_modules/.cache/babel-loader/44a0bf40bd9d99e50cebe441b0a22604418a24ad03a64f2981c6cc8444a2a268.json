{"ast":null,"code":"\"use strict\";\n\n/*!\n * Copyright 2018 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.makeMiddleware = void 0;\nconst onFinished = require(\"on-finished\");\nconst context_1 = require(\"../../utils/context\");\nconst http_request_1 = require(\"../../utils/http-request\");\n/**\n * Generates an express middleware that installs a request-specific logger on\n * the `request` object. It optionally can do HttpRequest timing that can be\n * used for generating request logs. This can be used to integrate with logging\n * libraries such as winston and bunyan.\n *\n * @param projectId Generated traceIds will be associated with this project.\n * @param makeChildLogger A function that generates logger instances that will\n * be installed onto `req` as `req.log`. The logger should include the trace in\n * each log entry's metadata (associated with the LOGGING_TRACE_KEY property.\n * @param emitRequestLog Optional. A function that will emit a parent request\n * log. While some environments like GAE and GCF emit parent request logs\n * automatically, other environments do not. When provided this function will be\n * called with a populated `CloudLoggingHttpRequest` which can be emitted as\n * request log.\n */\nfunction makeMiddleware(projectId, makeChildLogger, emitRequestLog) {\n  return (req, res, next) => {\n    // TODO(ofrobots): use high-resolution timer.\n    const requestStartMs = Date.now();\n    // Detect & establish context if we were the first actor to detect lack of\n    // context so traceContext is always available when using middleware.\n    const traceContext = context_1.getOrInjectContext(req, projectId, true);\n    // Install a child logger on the request object, with detected trace and\n    // span.\n    req.log = makeChildLogger(traceContext.trace, traceContext.spanId, traceContext.traceSampled);\n    // Emit a 'Request Log' on the parent logger, with detected trace and\n    // span.\n    if (emitRequestLog) {\n      onFinished(res, () => {\n        const latencyMs = Date.now() - requestStartMs;\n        const httpRequest = http_request_1.makeHttpRequestData(req, res, latencyMs);\n        emitRequestLog(httpRequest, traceContext.trace, traceContext.spanId, traceContext.traceSampled);\n      });\n    }\n    next();\n  };\n}\nexports.makeMiddleware = makeMiddleware;","map":{"version":3,"names":["onFinished","require","context_1","http_request_1","makeMiddleware","projectId","makeChildLogger","emitRequestLog","req","res","next","requestStartMs","Date","now","traceContext","getOrInjectContext","log","trace","spanId","traceSampled","latencyMs","httpRequest","makeHttpRequestData","exports"],"sources":["../../../../src/middleware/express/make-middleware.ts"],"sourcesContent":[null],"mappings":";;AAAA;;;;;;;;;;;;;;;;;;;AAiBA,MAAAA,UAAA,GAAAC,OAAA;AACA,MAAAC,SAAA,GAAAD,OAAA;AACA,MAAAE,cAAA,GAAAF,OAAA;AAUA;;;;;;;;;;;;;;;;AAgBA,SAAgBG,cAAcA,CAC5BC,SAAiB,EACjBC,eAIe,EACfC,cAKS;EAET,OAAO,CAACC,GAAkB,EAAEC,GAAwB,EAAEC,IAAc,KAAI;IACtE;IACA,MAAMC,cAAc,GAAGC,IAAI,CAACC,GAAG,EAAE;IAEjC;IACA;IACA,MAAMC,YAAY,GAAGZ,SAAA,CAAAa,kBAAkB,CAACP,GAAG,EAAEH,SAAS,EAAE,IAAI,CAAC;IAE7D;IACA;IACCG,GAAwC,CAACQ,GAAG,GAAGV,eAAe,CAC7DQ,YAAY,CAACG,KAAK,EAClBH,YAAY,CAACI,MAAM,EACnBJ,YAAY,CAACK,YAAY,CAC1B;IAED;IACA;IACA,IAAIZ,cAAc,EAAE;MAClBP,UAAU,CAACS,GAAG,EAAE,MAAK;QACnB,MAAMW,SAAS,GAAGR,IAAI,CAACC,GAAG,EAAE,GAAGF,cAAc;QAC7C,MAAMU,WAAW,GAAGlB,cAAA,CAAAmB,mBAAmB,CAACd,GAAG,EAAEC,GAAG,EAAEW,SAAS,CAAC;QAC5Db,cAAc,CACZc,WAAW,EACXP,YAAY,CAACG,KAAK,EAClBH,YAAY,CAACI,MAAM,EACnBJ,YAAY,CAACK,YAAY,CAC1B;MACH,CAAC,CAAC;;IAGJT,IAAI,EAAE;EACR,CAAC;AACH;AA/CAa,OAAA,CAAAnB,cAAA,GAAAA,cAAA"},"metadata":{},"sourceType":"script","externalDependencies":[]}