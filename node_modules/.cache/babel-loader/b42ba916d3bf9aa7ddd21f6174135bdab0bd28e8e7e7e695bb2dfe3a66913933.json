{"ast":null,"code":"\"use strict\";\n\n/*!\n * Copyright 2021 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.isRawHttpRequest = exports.makeHttpRequestData = void 0;\n/**\n * makeHttpRequestData turns raw incoming HTTPRequests into structured\n * HTTPRequest objects interpreted by Cloud Logging.\n *\n * @param req\n * @param res\n * @param latencyMilliseconds\n */\nfunction makeHttpRequestData(req, res, latencyMilliseconds) {\n  let requestUrl, protocol, requestMethod, userAgent, referer, status, responseSize, latency;\n  // Format request properties\n  if (req.url) requestUrl = req.url;\n  // OriginalURL overwrites inferred url\n  if ('originalUrl' in req && req.originalUrl) requestUrl = req.originalUrl;\n  // Format protocol from valid URL\n  if (requestUrl) {\n    try {\n      const url = new URL(requestUrl);\n      protocol = url.protocol;\n    } catch (e) {\n      // Library should not panic\n    }\n  }\n  req.method ? requestMethod = req.method : null;\n  if (req.headers && req.headers['user-agent']) {\n    req.headers['user-agent'] ? userAgent = req.headers['user-agent'] : null;\n    req.headers['referer'] ? referer = req.headers['referer'] : null;\n  }\n  // Format response properties\n  if (res) {\n    res.statusCode ? status = res.statusCode : null;\n    responseSize = res.getHeader && Number(res.getHeader('Content-Length')) || 0;\n  }\n  // Format latency\n  if (latencyMilliseconds) {\n    latency = {\n      seconds: Math.floor(latencyMilliseconds / 1e3),\n      nanos: Math.floor(latencyMilliseconds % 1e3 * 1e6)\n    };\n  }\n  // Only include the property if its value exists\n  return Object.assign({}, requestUrl ? {\n    requestUrl\n  } : null, protocol ? {\n    protocol\n  } : null, requestMethod ? {\n    requestMethod\n  } : null, userAgent ? {\n    userAgent\n  } : null, referer ? {\n    referer\n  } : null, responseSize ? {\n    responseSize\n  } : null, status ? {\n    status\n  } : null, latency ? {\n    latency\n  } : null);\n}\nexports.makeHttpRequestData = makeHttpRequestData;\n/**\n * isRawHttpRequest detects whether a request object extends the\n * http.IncomingMessage class. It should return true on HTTP compliant requests\n * and all requests created by an http.Server.\n *\n * @param req\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction isRawHttpRequest(req) {\n  if (req && ('originalUrl' in req || 'headers' in req || 'method' in req || 'url' in req)) {\n    return true;\n  }\n  return false;\n}\nexports.isRawHttpRequest = isRawHttpRequest;","map":{"version":3,"names":["makeHttpRequestData","req","res","latencyMilliseconds","requestUrl","protocol","requestMethod","userAgent","referer","status","responseSize","latency","url","originalUrl","URL","e","method","headers","statusCode","getHeader","Number","seconds","Math","floor","nanos","Object","assign","exports","isRawHttpRequest"],"sources":["../../../src/utils/http-request.ts"],"sourcesContent":[null],"mappings":";;AAAA;;;;;;;;;;;;;;;;;;;AAoDA;;;;;;;;AAQA,SAAgBA,mBAAmBA,CACjCC,GAAyC,EACzCC,GAAyB,EACzBC,mBAA4B;EAE5B,IAAIC,UAAU,EACZC,QAAQ,EACRC,aAAa,EACbC,SAAS,EACTC,OAAO,EACPC,MAAM,EACNC,YAAY,EACZC,OAAO;EACT;EACA,IAAIV,GAAG,CAACW,GAAG,EAAER,UAAU,GAAGH,GAAG,CAACW,GAAG;EACjC;EACA,IAAI,aAAa,IAAIX,GAAG,IAAIA,GAAG,CAACY,WAAW,EAAET,UAAU,GAAGH,GAAG,CAACY,WAAW;EACzE;EACA,IAAIT,UAAU,EAAE;IACd,IAAI;MACF,MAAMQ,GAAG,GAAG,IAAIE,GAAG,CAACV,UAAU,CAAC;MAC/BC,QAAQ,GAAGO,GAAG,CAACP,QAAQ;KACxB,CAAC,OAAOU,CAAC,EAAE;MACV;IAAA;;EAGJd,GAAG,CAACe,MAAM,GAAIV,aAAa,GAAGL,GAAG,CAACe,MAAM,GAAI,IAAI;EAChD,IAAIf,GAAG,CAACgB,OAAO,IAAIhB,GAAG,CAACgB,OAAO,CAAC,YAAY,CAAC,EAAE;IAC5ChB,GAAG,CAACgB,OAAO,CAAC,YAAY,CAAC,GAAIV,SAAS,GAAGN,GAAG,CAACgB,OAAO,CAAC,YAAY,CAAC,GAAI,IAAI;IAC1EhB,GAAG,CAACgB,OAAO,CAAC,SAAS,CAAC,GAAIT,OAAO,GAAGP,GAAG,CAACgB,OAAO,CAAC,SAAS,CAAC,GAAI,IAAI;;EAEpE;EACA,IAAIf,GAAG,EAAE;IACPA,GAAG,CAACgB,UAAU,GAAIT,MAAM,GAAGP,GAAG,CAACgB,UAAU,GAAI,IAAI;IACjDR,YAAY,GACTR,GAAG,CAACiB,SAAS,IAAIC,MAAM,CAAClB,GAAG,CAACiB,SAAS,CAAC,gBAAgB,CAAC,CAAC,IAAK,CAAC;;EAEnE;EACA,IAAIhB,mBAAmB,EAAE;IACvBQ,OAAO,GAAG;MACRU,OAAO,EAAEC,IAAI,CAACC,KAAK,CAACpB,mBAAmB,GAAG,GAAG,CAAC;MAC9CqB,KAAK,EAAEF,IAAI,CAACC,KAAK,CAAEpB,mBAAmB,GAAG,GAAG,GAAI,GAAG;KACpD;;EAEH;EACA,OAAOsB,MAAM,CAACC,MAAM,CAClB,EAAE,EACFtB,UAAU,GAAG;IAACA;EAAU,CAAC,GAAG,IAAI,EAChCC,QAAQ,GAAG;IAACA;EAAQ,CAAC,GAAG,IAAI,EAC5BC,aAAa,GAAG;IAACA;EAAa,CAAC,GAAG,IAAI,EACtCC,SAAS,GAAG;IAACA;EAAS,CAAC,GAAG,IAAI,EAC9BC,OAAO,GAAG;IAACA;EAAO,CAAC,GAAG,IAAI,EAC1BE,YAAY,GAAG;IAACA;EAAY,CAAC,GAAG,IAAI,EACpCD,MAAM,GAAG;IAACA;EAAM,CAAC,GAAG,IAAI,EACxBE,OAAO,GAAG;IAACA;EAAO,CAAC,GAAG,IAAI,CAC3B;AACH;AAxDAgB,OAAA,CAAA3B,mBAAA,GAAAA,mBAAA;AA0DA;;;;;;;AAOA;AACA,SAAgB4B,gBAAgBA,CAAC3B,GAAS;EACxC,IACEA,GAAG,KACF,aAAa,IAAIA,GAAG,IACnB,SAAS,IAAIA,GAAG,IAChB,QAAQ,IAAIA,GAAG,IACf,KAAK,IAAIA,GAAG,CAAC,EACf;IACA,OAAO,IAAI;;EAEb,OAAO,KAAK;AACd;AAXA0B,OAAA,CAAAC,gBAAA,GAAAA,gBAAA"},"metadata":{},"sourceType":"script","externalDependencies":[]}